T.cache("X.ZoneDragDrop","K",function(k){k=K.entity(k.pkg);var o=15,p=20,h=15,n=120,l=["mousedown","touchstart"],q={table:"tbody"};k.ZoneDragDrop=K.clazz(K.ME,function(r,s,f){K.mix(f,{LEFT:1,TOP:2,RIGHT:4,BOTTOM:8,DRAG_START:"_drag_start",DRAG_END:"_drag_end",DRAG_MOVE:"_drag_move",HOVER_CHILD_CHANGED:"_hover_child_changed",HOVER_CHILD_PLACE_CHANGED:"_hover_child_place_changed",HOVER_NODE_CHANGED:"_hover_node_changed",ZONE_SCROLL:"_zone_scroll",WIN_SCROLL:"_win_scroll"});return{addZone:function(b){var a=
this;if(b=K(b)){K.nodeClean(b);var c=b.tagName.toLowerCase();if(q[c]==b.firstChild.tagName.toLowerCase())b=b.firstChild;if(!a.$list)a.$list=[];if(!~K.arrFind(a.$list,b)){a.$list.push(b);if(!a.$dragStart)a.$dragStart=K.bind(a.dragStart,a);K.on(b,l,a.$dragStart)}}},findHoverZone:function(b){var a=this;a=a.$list;if(K.isArr(a))for(var c=0;c<a.length;c++)if(K.nodeIn(b,a[c]))return a[c];return null},findHoverNodePosition:function(b,a){var c=0,d=0,e=-1,g=-1,i=-1,m=-1,j=false;if(a.pageX>=b.x&&a.pageX<=b.x+
b.width){c|=a.pageX<=b.x+b.width/2?f.LEFT:f.RIGHT;e=a.pageX-b.x;i=b.x+b.width-a.pageX;j=true}if(a.pageY>=b.y&&a.pageY<=b.y+b.height){c|=a.pageY<=b.y+b.height/2?f.TOP:f.BOTTOM;g=a.pageY-b.y;m=b.y+b.height-a.pageY;j=true}if(j){b=Math.min(e,g,i,m);if(b>-1)if(b==e)d=f.LEFT;else if(b==g)d=f.TOP;else if(b==i)d=f.RIGHT;else if(b==m)d=f.BOTTOM}return{position:c,atPlace:j,side:d}},findDirectChild:function(b,a){var c=this,d=null;if(a=a||c.findHoverZone(b))for(;a!=b;)if(b.parentNode==a){d=b;break}else b=b.parentNode;
return{child:d,zone:a}},dragStart:function(b){var a=this;b=K.evt(b);a.$hoverInfo={};if(K.evtHitest(b)){var c=K.evtTarget(b);c=a.findDirectChild(c);if(c.child){a.$dragStartChild=c.child;b={evtXY:K.evtXY(b),dragStartZone:c.zone,dragChild:c.child};a.fire(f.DRAG_START,b);if(!b.cancel){if(!a.$dragMove)a.$dragMove=K.bind(a.dragMove,a);if(!a.$dragEnd)a.$dragEnd=K.bind(a.dragEnd,a);K.startDrag(c.zone,a.$dragMove,a.$dragEnd)}}}},testHoverChildPlace:function(b,a,c){var d=this;a=d.findHoverNodePosition(b,a);
if(d.$lastHoverChildSide!==a.side||d.$lastHoverChildPos!==a.position){d.fire(f.HOVER_CHILD_PLACE_CHANGED,K.mix({position:a.position,positionChanged:d.$lastHoverChildPos!==a.position,sideChanged:d.$lastHoverChildSide!==a.side,side:a.side,atPlace:a.atPlace,childBound:b},c));d.$lastHoverChildSide=a.side;d.$lastHoverChildPos=a.position}},dragMove:function(b,a,c){a=this;var d=K.nodeByXY(c.viewX,c.viewY,K.nodeDoc(b)),e;a.$hasMove=true;a.$evtXY=c;a.startZoneScroll();a.startWinScroll();a.fire(f.DRAG_MOVE,
{evtXY:c});if(!(a.$zoneIsScrolling||a.$winIsScrolling))if(a.$lastHoverChild!=d){e={hoverNode:d};a.fire(f.HOVER_NODE_CHANGED,e);if(!e.cancel){a.$lastHoverChild=d;delete a.$lastHoverChildSide;if(e=a.findHoverZone(d)){delete a.$fireNull;d=a.findDirectChild(d,e);e={dragStartZone:b,currentZone:e,hoverChild:d.child,dragChild:a.$dragStartChild,evtXY:c};a.$hoverInfo=e;a.$hoverChildBound=K.nodeBound(d.child);a.$hoverZoneBound=K.nodeBound(d.zone);a.fire(f.HOVER_CHILD_CHANGED,e);a.testHoverChildPlace(a.$hoverChildBound,
c,e)}else if(!a.$fireNull){delete a.$hoverChildBound;delete a.$hoverZoneBound;a.$fireNull=true;e={dragStartZone:b,currentZone:e,hoverChild:null,dragChild:a.$dragStartChild,evtXY:c};a.$hoverInfo=e;a.fire(f.HOVER_CHILD_CHANGED,e);a.fire(f.HOVER_CHILD_PLACE_CHANGED,K.mix({position:0,side:0,positionChanged:true,sideChanged:true,atPlace:false,childBound:K.nodeBound()},e));delete a.$lastHoverChildPos;delete a.$lastHoverChildSide}}}else a.$hoverChildBound&&a.testHoverChildPlace(a.$hoverChildBound,c,a.$hoverInfo)},
dragEnd:function(b,a){var c=this,d=c.$hasMove;c.fire(f.DRAG_END,{atPlace:c.$lastHoverChildPos||c.$lastHoverChildSide,srcEvent:a,dragChild:c.$dragStartChild,dropChild:d?c.$hoverInfo.hoverChild:null,dropZone:d?c.$hoverInfo.currentZone:null,dragStartZone:b,position:c.$lastHoverChildPos,side:c.$lastHoverChildSide});delete c.$fireNull;delete c.$lastHoverChild;delete c.$lastHoverChildSide;delete c.$lastHoverChildPos;delete c.$hasMove;delete c.$evtXY;delete c.$hoverChildBound;delete c.$hoverInfo;delete c.$hoverZoneBound;
delete c.$dragStartChild;delete c.$zoneIsScrolling;delete c.$winIsScrolling;c.stopZoneScroll();c.stopWinScroll()},startZoneScroll:function(){var b=this;if(!b.$stm)b.$stm=new K.TM(n);if(!b.$zoneScroll){b.$zoneScroll=function(){var a=b.$hoverZoneBound,c=b.$hoverInfo;if(a&&c){var d=0,e=0,g=b.$evtXY;c=c.currentZone;var i=p;if(g.pageX>=a.x&&g.pageX<=a.x+a.width&&g.pageY>=a.y&&g.pageY<=a.y+a.height){if(g.pageX-a.x<i&&a.scrollX>0)d=-Math.min(h,a.scrollX);else if(a.x+a.width-g.pageX<i&&a.scrollX+a.width<
a.maxWidth)d=Math.min(h,a.maxWidth-a.scrollX-a.width);if(g.pageY-a.y<i&&a.scrollY>0)e=-Math.min(h,a.scrollY);else if(a.y+a.height-g.pageY<i&&a.scrollY+a.height<a.maxHeight)e=Math.min(h,a.maxHeight-a.scrollY-a.height)}if(d||e){delete b.$hasMove;b.$zoneIsScrolling=true;b.$preventWinScroll=true;c.scrollTop+=e;c.scrollLeft+=d;a.scrollX+=d;a.scrollY+=e;b.fire(f.ZONE_SCROLL)}else{delete b.$zoneIsScrolling;delete b.$preventWinScroll}}};b.$stm.on(b.$zoneScroll)}},stopZoneScroll:function(){var b=this;b.$stm&&
b.$stm.un(b.$zoneScroll);delete b.$zoneScroll;delete b.$preventWinScroll},startWinScroll:function(){var b=this;if(!b.$stm)b.$stm=new K.TM(n);if(!b.$winScroll){b.$winScroll=function(){if(!b.$preventWinScroll){var a=b.$evtXY,c=K.body(),d=o,e=0,g=0;if(a.pageX-c.scrollX<d&&c.scrollX>0)e=-Math.min(h,c.scrollX);else if(c.scrollX+c.width-a.pageX<d&&c.scrollX+c.width<c.maxWidth)e=Math.min(h,c.maxWidth-c.scrollX-c.width);if(a.pageY-c.scrollY<d&&c.scrollY>0)g=-Math.min(h,c.scrollY);else if(c.scrollY+c.height-
a.pageY<d&&c.scrollY+c.height<c.maxHeight)g=Math.min(h,c.maxHeight-c.scrollY-c.height);if(e||g){delete b.$hasMove;b.$winIsScrolling=true;a.pageX+=e;a.pageY+=g;b.fire(f.DRAG_MOVE,{evtXY:a});window.scrollBy(e,g);b.fire(f.WIN_SCROLL)}else delete b.$winIsScrolling}};b.$stm.on(b.$winScroll)}},stopWinScroll:function(){var b=this;b.$stm&&b.$stm.un(b.$winScroll);delete b.$winScroll;delete b.$stm},removeZone:function(b){b=K(b);var a=this,c=a.$list;K.arrRemove(c,b);K.un(b,l,a.$dragStart)},dispose:function(){var b=
this,a=b.$list;if(K.isArr(a))for(var c=0;c<a.length;c++)K.un(a[c],l,b.$dragStart);b.$list=[]}}})});
